@inject AppState AppState
@implements IDisposable

@if (IsEditMode && isSelected)
{
    <EditBranchBlock Model="@Model" CssClass="@CssClass" OnChildAdded="@HandleChildAdded" />
}
else
{
    <PreviewBranchBlock Model="@Model" CssClass="@CssClass" OnBlockSelected="@HandleBlockSelected" />
}


@code {
    [Parameter] public string CssClass { get; set; }

    [Parameter] public BranchBlockModel Model { get; set; }

    [CascadingParameter] bool IsEditMode { get; set; }

    bool isSelected => Model.Id == AppState.SelectedBlockId;


    protected override void OnInitialized()
    {
        AppState.OnChange += AppStateChanged;
    }

    public void Dispose()
    {
        AppState.OnChange -= AppStateChanged;
    }

    void AppStateChanged() => StateHasChanged();

    void HandleBlockSelected(Guid id) => AppState.SetSelectedBlockId(id);

    void HandleChildAdded(bool left)
    {
        AppState.SetSelectedBlockId(left ? Model.LeftResult.Id : Model.RightResult.Id);
        StateHasChanged();
    }
}
