@page "/diagram"
@page "/diagram/{id:guid}"

@inject AppState AppState
@inject IDiagramService persistenceService;
@implements IDisposable

<PageHeader>
    @if (isEditMode)
    {
        <span class="diagram__name--edit">
            <input @bind="@model.Name" @bind:event="oninput" placeholder="diagram name" />
        </span>
    }
    else
    {
        <h1 class="diagram__name">
            @model?.Name
        </h1>
    }
</PageHeader>

<PageContent>

    @if (model is null)
    {
        <p>Loading diagram...</p>
    }
    else
    {
        @if (firstBlockSelectorVisible)
        {
            <FirstBlockSelector OnTextBlockSelected="@HandleFirstBlockText" OnBranchBlockSelected="@HandleFirstBlockBranch" />
        }
        else
        {
            @if (isEditMode)
            {
                <div class="diagram__edit-info">
                    <SvgIcon SvgUrl="/assets/info-icon.svg" />
                    Click on item below to start editing
                </div>
            }

            <div class="diagram__wrapper">

                <CascadingValue Value="@isEditMode">

                    <Block Model="@model.RootBlock" />

                </CascadingValue>

            </div>
        }
    }

    <DiagramMenu EditMode="@isEditMode" OnEdit="@HandleEdit" OnPreview="@HandlePreview" OnDelete=@HandleDelete OnDownload="@HandleDownload" OnSave="@HandleSave" />

</PageContent>

@if (deleteDialogVisible)
{
    <DeleteDiagramDialog DiagramName="@model.Name" OnCancel="@HandleDeleteCancel" OnConfirm="@HandleDeleteConfirm" />
}

@if (savingDialogVisible)
{
    <div class="diagram__saving-dialog">
        Saving diagram...
    </div>
}

@if (errorDialogVisible)
{
    <div class="diagram__info-dialog">

        <span class="diagram__info-dialog-icon diagram__info-dialog-icon--error">
            <SvgIcon SvgUrl="/assets/error-icon.svg" />
        </span>

        <p class="diagram__info-dialog-message diagram__info-dialog-message--error">
            @errorMessage
        </p>

        <button class="diagram__info-dialog-close" title="close" @onclick="() => errorMessage=string.Empty">
            <SvgIcon SvgUrl="/assets/close-icon.svg" />
        </button>

    </div>
}

@if (successDialogVisible)
{
    <div class="diagram__info-dialog">

        <span class="diagram__info-dialog-icon">
            <SvgIcon SvgUrl="/assets/info-icon.svg" />
        </span>

        <p class="diagram__info-dialog-message">
            @successMessage
        </p>

        <button class="diagram__info-dialog-close" title="close" @onclick="() => successMessage=string.Empty">
            <SvgIcon SvgUrl="/assets/close-icon.svg" />
        </button>

    </div>

}

@code {
    [Parameter] public Guid? Id { get; set; }

    DiagramModel model;

    bool isEditMode;
    bool deleteDialogVisible;
    bool savingDialogVisible;

    string successMessage;
    bool successDialogVisible => !string.IsNullOrEmpty(successMessage);

    string errorMessage;
    bool errorDialogVisible => !string.IsNullOrEmpty(errorMessage);

    bool firstBlockSelectorVisible => model?.RootBlock is null;

    protected override async Task OnParametersSetAsync()
    {
        if (Id is not null)
        {
            var diagram = await persistenceService.GetDiagramAsync(Id.Value);

            if (diagram is null)
            {
                // show error message

                return;
            }

            AppState.SetCurrentDiagram(diagram);
        }

        if (AppState.CurrentDiagram is null)
            AppState.SetCurrentDiagram(DiagramHelpers.GetNewDiagram());

        model = AppState.CurrentDiagram;

        if (firstBlockSelectorVisible)
            isEditMode = true;
    }


    protected override void OnInitialized()
    {
        AppState.OnChange += AppStateChanged;
    }

    public void Dispose()
    {
        AppState.OnChange -= AppStateChanged;
        AppState.SetCurrentDiagram(null);
    }

    void AppStateChanged() => StateHasChanged();

    void HandleFirstBlockText()
    {
        model.RootBlock = new TextBlockModel();
        AppState.SelectBlock(model.RootBlock.Id);
    }

    void HandleFirstBlockBranch()
    {
        model.RootBlock = new BranchBlockModel();
        AppState.SelectBlock(model.RootBlock.Id);
    }

    void HandleEdit()
    {
        isEditMode = true;
        AppState.SelectBlock(null);
    }

    void HandlePreview()
    {
        isEditMode = false;
    }

    void HandleDelete()
    {
        deleteDialogVisible = true;
    }

    void HandleDeleteCancel()
    {
        deleteDialogVisible = false;
    }

    void HandleDeleteConfirm()
    {
        // TODO
        deleteDialogVisible = false;
    }

    async Task HandleDownload()
    {
        await persistenceService.DownloadDiagramAsync(model);
    }

    async Task HandleSave()
    {
        isEditMode = false;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        savingDialogVisible = true;

        var result = await persistenceService.SaveDiagramAsync(model);

        savingDialogVisible = false;

        if (result)
            successMessage = "diagram has been saved ";
        else
            errorMessage = "an error occurred while saving diagram";
    }
}
