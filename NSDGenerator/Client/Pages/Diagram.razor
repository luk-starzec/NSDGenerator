@page "/diagram"
@inject AppState AppState
@inject IPersistenceService persistenceService;
@implements IDisposable

<PageHeader>
    @if (isEditMode)
    {
        <input class="diagram__name--edit" @bind="@model.Name" @bind:event="oninput" placeholder="diagram name" />
    }
    else
    {
        <AuthorizeView>
            <NotAuthorized>
                <h1 class="diagram__name">
                    @model?.Name
                </h1>
            </NotAuthorized>
            <Authorized>
                <h1 class="diagram__name--short">
                    @model?.Name
                </h1>
            </Authorized>
        </AuthorizeView>
    }
</PageHeader>

<PageContent>

    @if (firstBlockSelectorVisible)
    {
        <FirstBlockSelector OnTextBlockSelected="@HandleFirstBlockText" OnBranchBlockSelected="@HandleFirstBlockBranch" />
    }
    else
    {
        @if (isEditMode)
        {
            <div class="diagram__edit-info">
                <SvgIcon SvgUrl="/assets/info-icon.svg" />
                Click on item below to start editing
            </div>
        }

        <div class="diagram__wrapper">

            <CascadingValue Value="@isEditMode">

                <Block Model="@model.RootBlock" />

            </CascadingValue>

        </div>

    }

    <DiagramMenu EditMode="@isEditMode" OnEdit="@HandleEdit" OnPreview="@HandlePreview" OnDelete=@HandleDelete OnDownload="@HandleDownload" />

</PageContent>

@if (deleteDialogVisible)
{
    <DeleteDiagramDialog DiagramName="@model.Name" OnCancel="@HandleDeleteCancel" OnConfirm="@HandleDeleteConfirm" />
}

@code {
    DiagramModel model;

    bool isEditMode;
    bool deleteDialogVisible;
    bool firstBlockSelectorVisible => model?.RootBlock is null;

    protected override void OnInitialized()
    {
        if (AppState.CurrentDiagram is null)
            AppState.SetCurrentDiagram(DiagramHelpers.GetNewDiagram());

        model = AppState.CurrentDiagram;

        AppState.OnChange += AppStateChanged;

        if (firstBlockSelectorVisible)
            isEditMode = true;
    }

    public void Dispose()
    {
        AppState.OnChange -= AppStateChanged;
    }

    void AppStateChanged() => StateHasChanged();

    void HandleFirstBlockText()
    {
        model.RootBlock = new TextBlockModel();
        AppState.SelectBlock(model.RootBlock.Id);
    }

    void HandleFirstBlockBranch()
    {
        model.RootBlock = new BranchBlockModel();
        AppState.SelectBlock(model.RootBlock.Id);
    }

    void HandleEdit()
    {
        isEditMode = true;
        AppState.SelectBlock(null);
    }

    void HandlePreview()
    {
        isEditMode = false;
    }

    void HandleDelete()
    {
        deleteDialogVisible = true;
    }

    void HandleDeleteCancel()
    {
        deleteDialogVisible = false;
    }

    void HandleDeleteConfirm()
    {
        // TODO
        deleteDialogVisible = false;
    }

    async Task HandleDownload()
    {
        await persistenceService.DownloadDiagram(model);
    }
}
